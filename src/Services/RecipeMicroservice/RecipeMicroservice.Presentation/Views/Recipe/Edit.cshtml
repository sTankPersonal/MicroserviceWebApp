@using RecipeMicroservice.Presentation
@using RecipeMicroservice.Presentation.Models
@using RecipeMicroservice.Presentation.Models.Recipe
@using RecipeMicroservice.Presentation.Models.RecipeCategory
@using RecipeMicroservice.Presentation.Models.RecipeIngredient
@using RecipeMicroservice.Presentation.Models.RecipeInstruction
@model UpdateAndAttachElementsRecipeViewModel
@{
	ViewData["Title"] = "Edit Recipe";
}

<h2>Edit Recipe - @Model.UpdateRecipe.Name</h2>

<form asp-controller="Recipe" asp-action="Edit" asp-route-id="@Model.UpdateRecipe.Id" method="post">
	<input type="hidden" asp-for="UpdateRecipe.Id" />
	<div class="mb-3">
		<label asp-for="UpdateRecipe.Name" class="form-label"></label>
		<input asp-for="UpdateRecipe.Name" class="form-control" />
		<span asp-validation-for="UpdateRecipe.Name" class="text-danger"></span>
	</div>
	<div class="mb-3">
		<label asp-for="UpdateRecipe.PrepTimeInMinutes" class="form-label"></label>
		<input asp-for="UpdateRecipe.PrepTimeInMinutes" class="form-control" type="number" />
		<span asp-validation-for="UpdateRecipe.PrepTimeInMinutes" class="text-danger"></span>
	</div>
	<div class="mb-3">
		<label asp-for="UpdateRecipe.CookTimeInMinutes" class="form-label"></label>
		<input asp-for="UpdateRecipe.CookTimeInMinutes" class="form-control" type="number" />
		<span asp-validation-for="UpdateRecipe.CookTimeInMinutes" class="text-danger"></span>
	</div>
	<div class="mb-3">
		<label asp-for="UpdateRecipe.Servings" class="form-label"></label>
		<input asp-for="UpdateRecipe.Servings" class="form-control" typeof="number">
		<span asp-validation-for="UpdateRecipe.Servings" class="text-danger"></span>
	</div>
	<button type="submit" class="btn btn-primary">Save</button>
	<a asp-action="Index" class="btn btn-secondary">Cancel</a>
</form>

<hr />

<h4>Categories</h4>

<table class="table table-striped mb-3">
	<thead>
		<tr>
			<th>Category</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		<form asp-controller="Recipe"
			asp-action="AddCategory"
			  asp-route-id="@Model.UpdateRecipe.Id"
			method="post"
			class="row g-2 align-items-center mb-3">
			<tr>
				<td>
					<select asp-for="AttachElements.NewCategory.CategoryId"
						class="form-select select2-field"
						data-placeholder="New Category"
						data-ajax-base-url= "/api/Category/Ajax"
						data-ajax-text-field="text"
						data-ajax-id-field="id"
						data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}'>
					</select>
				</td>
			<td style="white-space: nowrap; width: 1%;">
					<button type="submit" class="btn btn-primary">Add Category</button>
				</td>
			</tr>
		</form>

		@if (Model.UpdateRecipe.RecipeCategories.IsEmpty)
		{
			<tr>
				<td colspan="4">No categories added yet.</td>
			</tr>
		}
		else
		{
			@foreach (UpdateRecipeCategoryViewModel category in Model.UpdateRecipe.RecipeCategories.Items)
			{
				<form asp-controller="Recipe"
					  asp-action="EditCategory"
					  asp-route-id="@Model.UpdateRecipe.Id"
					  asp-route-recipeCategoryId="@category.Id"
					  method="post">
				<tr>
					<td>
						<select name="UpdateRecipe.RecipeCategories.CategoryId"
								class="form-select select2-field"
								data-placeholder="Category"
								data-ajax-base-url="/api/Category/Ajax"
								data-ajax-text-field="text"
								data-ajax-id-field="id"
								data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}'
								data-initial-id="@category.CategoryId"
								data-initial-text="@category.CategoryName">
							<option value="@category.CategoryId">@category.CategoryName</option>
						</select>
					</td>
					<td style="white-space: nowrap; width: 1%;">
						<input type="hidden" name="UpdateRecipe.RecipeCategories.Id" value="@category.Id" />
						<button type="submit" class="btn btn-warning btn-sm">Save</button>
						<a asp-controller="Recipe"
						   asp-action="RemoveCategory"
						   asp-route-id="@Model.UpdateRecipe.Id"
						   asp-route-recipeCategoryId="@category.Id"
						   class="btn btn-danger btn-sm">Delete</a>
					</td>
				</tr>
				</form>
			}

		}
	</tbody>
</table>

<hr/>


<h4>Ingredients</h4>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Ingredient</th>
			<th>Quantity</th>
			<th>Unit</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
		<form asp-controller="Recipe"
			asp-action="AddIngredient"
			asp-route-id="@Model.UpdateRecipe.Id"
			method="post">
			@* class="row g-2 align-items-center mb-3"> *@
			<tr>
				<td>
					<select asp-for="AttachElements.NewIngredient.IngredientId"
						class="form-select select2-field"
						data-placeholder="New Ingredient"
						data-ajax-base-url="/api/Ingredient/Ajax"
						data-ajax-text-field="text"
						data-ajax-id-field="id"
						data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}'>
					</select>
				</td>
				<td>
				<input asp-for="AttachElements.NewIngredient.Quantity" class="form-control" type="number" step="any" />
				<span asp-validation-for="AttachElements.NewIngredient.Quantity" class="text-danger"></span>
				</td>
				<td>
				<select asp-for="AttachElements.NewIngredient.UnitId"
						class="form-select select2-field"
						data-placeholder="Unit"
						data-ajax-base-url="/api/Unit/Ajax"
						data-ajax-text-field="text"
						data-ajax-id-field="id"
						data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}'>
					</select>
				</td>
				<td style="white-space: nowrap; width: 1%;">
					<button type="submit" class="btn btn-primary">Add Ingredient</button>
				</td>
			</tr>
		</form>

		@if (Model.UpdateRecipe.RecipeIngredients.IsEmpty)
		{
			<tr>
				<td colspan="4">No ingredients added yet.</td>
			</tr>
		}
		else
		{
			@foreach (UpdateRecipeIngredientViewModel ingredient in Model.UpdateRecipe.RecipeIngredients.Items)
			{
				<form asp-controller="Recipe"
					  asp-action="EditIngredient"
					  asp-route-id="@Model.UpdateRecipe.Id"
					  asp-route-recipeIngredientId="@ingredient.Id"
					  method="post">

				<tr>
					<td>
						<select name="UpdateRecipe.RecipeIngredients.IngredientId"
								class="form-select select2-field"
								data-placeholder="Ingredient"
								data-ajax-base-url="/api/Ingredient/Ajax"
								data-ajax-text-field="text"
								data-ajax-id-field="id"
								data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}'
								data-initial-id="@ingredient.IngredientId"
								data-initial-text="@ingredient.IngredientName">
							<option value="@ingredient.IngredientId">@ingredient.IngredientName</option>
						</select>
					</td>
					<td>
						<input name="UpdateRecipe.RecipeIngredients.Quantity"
							   class="form-control"
							   type="number"
							   step="any"
							   value="@ingredient.Quantity" />
						<span asp-validation-for="UpdateRecipe.RecipeIngredients.Items.First().Quantity" class="text-danger"></span>
					</td>
					<td>
						<select name="UpdateRecipe.RecipeIngredients.UnitId" class="form-select select2-field" data-placeholder="Unit" data-ajax-base-url="/api/Unit/Ajax" data-ajax-text-field="text" data-ajax-id-field="id" data-ajax-payload='{"SearchName":"term","PageNumber":"page","PageSize":10}' data-initial-id="@ingredient.UnitId" data-initial-text="@ingredient.UnitName">
							<option value="@ingredient.UnitId">@ingredient.UnitName</option>
						</select>
					</td>
					<td style="white-space: nowrap; width: 1%;">
						<input type="hidden" name="UpdateRecipe.RecipeIngredients.Id" value="@ingredient.Id" />
						<button type="submit" class="btn btn-warning btn-sm">Save</button>
						<a asp-controller="Recipe" asp-action="RemoveIngredient" asp-route-id="@Model.UpdateRecipe.Id" asp-route-recipeIngredientId="@ingredient.Id" class="btn btn-danger btn-sm">Delete</a>
					</td>
				</tr>
				</form>
			}
		}
	</tbody>
</table>

<hr/>

<h4>Steps</h4>

<table class="table table-striped">
    <thead>
        <tr>
			<th>Step Number</th>
            <th>Instructions</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
		<form asp-controller="Recipe" asp-action="AddInstruction" asp-route-id="@Model.UpdateRecipe.Id" method="post" class="row g-2 align-items-center mb-3">
			<tr>
			<input type="hidden" name="RecipeId" value="@Model.UpdateRecipe.Id" />
				<td>
					<input asp-for="AttachElements.NewInstruction.StepNumber" class="form-control" type="number" />
					<span asp-validation-for="AttachElements.NewInstruction.StepNumber" class="text-danger"></span>
				</td>
				<td>
					<input asp-for="AttachElements.NewInstruction.Description" class="form-control" />
					<span asp-validation-for="AttachElements.NewInstruction.Description" class="text-danger"></span>
				</td>
				<td style="white-space: nowrap; width: 1%;">
					<button type="submit" class="btn btn-primary">Add Step</button>
				</td>
			</tr>	
		</form>

		@if (Model.UpdateRecipe.RecipeInstructions.IsEmpty)
		{
			<tr>
				<td colspan="4">No instructions added yet.</td>
			</tr>
		}
		else
		{
			@foreach (UpdateRecipeInstructionViewModel step in Model.UpdateRecipe.RecipeInstructions.Items.OrderBy(s => s.StepNumber).ThenBy(s => s.Id))
			{
				<form asp-controller="Recipe" asp-action="EditInstruction" asp-route-id="@Model.UpdateRecipe.Id" asp-route-recipeInstructionId="@step.Id" method="post">
					<tr>
						<td>
							<input name="UpdateRecipe.RecipeInstructions.StepNumber" class="form-control" type="number" value="@step.StepNumber" />
						</td>
						<td>
							<input name="UpdateRecipe.RecipeInstructions.Description" class="form-control" value="@step.Description" />
						</td>
						<td style="white-space: nowrap; width: 1%;">
							<input type="hidden" name="UpdateRecipe.RecipeInstructions.Id" value="@step.Id" />
							<button type="submit" class="btn btn-warning btn-sm">Save</button>
							<a asp-controller="Recipe" asp-action="RemoveInstruction" asp-route-id="@Model.UpdateRecipe.Id" asp-route-recipeInstructionId="@step.Id" class="btn btn-danger btn-sm">Delete</a>
						</td>
					</tr>
				</form>
			}

		}
	</tbody>
</table>

@section Scripts {
	<script src="~/js/select2-ajax.js"></script>
	<script src="~/js/delete-confirmation.js"></script>
}